name: Release Binaries

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libasound2-dev \
            libudev-dev \
            libwayland-dev \
            wayland-protocols \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libx11-dev \
            libxrandr-dev \
            libxi-dev \
            libxcursor-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build (release)
        run: cargo build -p foil_rs_bevy --release --bin FoilRs --locked

      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME}"
          OS="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          ARCH="$(echo "${RUNNER_ARCH}" | tr '[:upper:]' '[:lower:]')"

          STAGE="FoilRs-${VERSION}-${OS}-${ARCH}"
          mkdir -p "dist/${STAGE}"
          cp "target/release/FoilRs" "dist/${STAGE}/FoilRs"
          cp "LICENSE" "dist/${STAGE}/LICENSE"
          if [[ -d "assets" ]]; then
            cp -R "assets" "dist/${STAGE}/assets"
          fi

          tar -C dist -czf "dist/${STAGE}.tar.gz" "${STAGE}"
          rm -rf "dist/${STAGE}"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $version = $env:GITHUB_REF_NAME
          $os = $env:RUNNER_OS.ToLower()
          $arch = $env:RUNNER_ARCH.ToLower()
          $stage = "FoilRs-$version-$os-$arch"
          New-Item -ItemType Directory -Force -Path "dist/$stage" | Out-Null
          Copy-Item "target/release/FoilRs.exe" "dist/$stage/FoilRs.exe"
          Copy-Item "LICENSE" "dist/$stage/LICENSE"
          if (Test-Path "assets") { Copy-Item "assets" "dist/$stage/assets" -Recurse }
          Compress-Archive -Path "dist/$stage" -DestinationPath "dist/$stage.zip" -Force
          Remove-Item -Recurse -Force "dist/$stage"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FoilRs-${{ github.ref_name }}-${{ runner.os }}-${{ runner.arch }}
          path: dist/*.*

  release:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
          generate_release_notes: true
