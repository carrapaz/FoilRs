name: Publish

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run `cargo publish --dry-run` only"
        type: choice
        options: ["true", "false"]
        default: "true"
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libasound2-dev \
            libudev-dev \
            libwayland-dev \
            wayland-protocols \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libx11-dev \
            libxrandr-dev \
            libxi-dev \
            libxcursor-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev

      - name: Resolve publish mode
        id: mode
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.dry_run }}" == "true" ]]; then
              echo "args=--dry-run" >> "${GITHUB_OUTPUT}"
              exit 0
            fi
          fi
          echo "args=" >> "${GITHUB_OUTPUT}"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Ensure crates.io token configured
        if: steps.mode.outputs.args == ''
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${CRATES_IO_TOKEN}" ]]; then
            echo "Missing secret CRATES_IO_TOKEN"
            exit 1
          fi

      - name: Publish foil_rs
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          args="${{ steps.mode.outputs.args }}"
          log="$(mktemp)"
          if cargo publish -p foil_rs --locked ${args} 2>&1 | tee "${log}"; then
            exit 0
          fi
          if grep -q "already exists on crates.io index" "${log}"; then
            echo "foil_rs already published; continuing."
            exit 0
          fi
          exit 1

      - name: Publish foil_rs_bevy (retry for index propagation)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          set -euo pipefail
          args="${{ steps.mode.outputs.args }}"
          for i in {1..10}; do
            log="$(mktemp)"
            if cargo publish -p foil_rs_bevy --locked ${args} 2>&1 | tee "${log}"; then
              exit 0
            fi
            if grep -q "already exists on crates.io index" "${log}"; then
              echo "foil_rs_bevy already published; done."
              exit 0
            fi
            echo "publish failed (attempt $i/10); waiting for crates.io index propagation..."
            sleep 30
          done
          echo "failed to publish foil_rs_bevy after retries"
          exit 1
